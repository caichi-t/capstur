<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screen Capture Overlay</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: rgba(0, 0, 0, 0.3);
            cursor: crosshair;
            overflow: hidden;
            user-select: none;
            width: 100vw;
            height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .selection-box {
            position: absolute;
            border: 2px solid #007AFF;
            background: rgba(0, 122, 255, 0.1);
            box-shadow: 0 0 20px rgba(0, 122, 255, 0.3);
            pointer-events: none;
            display: none;
        }
        
        .info-panel {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            display: none;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        
        .capture-controls {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            gap: 12px;
            z-index: 10000;
            pointer-events: auto;
        }
        
        .capture-btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
            z-index: 10001;
            position: relative;
            pointer-events: auto;
        }
        
        .capture-btn:hover {
            background: #0056CC;
            transform: scale(1.05);
        }
        
        .capture-btn.cancel {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .capture-btn.cancel:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .instructions {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            backdrop-filter: blur(10px);
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="instructions">
        ドラッグしてキャプチャする範囲を選択してください
    </div>
    
    <div class="selection-box" id="selectionBox"></div>
    <div class="info-panel" id="infoPanel"></div>
    
    <div class="capture-controls" id="captureControls">
        <button class="capture-btn" id="captureBtn">キャプチャ</button>
        <button class="capture-btn cancel" id="cancelBtn">キャンセル</button>
    </div>

    <script>
        let isSelecting = false;
        let startX, startY, endX, endY;
        let selectionBox = document.getElementById('selectionBox');
        let infoPanel = document.getElementById('infoPanel');
        let captureControls = document.getElementById('captureControls');
        let captureBtn = document.getElementById('captureBtn');
        let cancelBtn = document.getElementById('cancelBtn');
        
        // Wait for Tauri API to be available
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM Content Loaded');
            if (!window.__TAURI__) {
                console.error('Tauri API not available');
                return;
            }
            console.log('Tauri API is available');
            console.log('Window dimensions:', window.innerWidth, 'x', window.innerHeight);
        });
        
        // Also log when the window is fully loaded
        window.addEventListener('load', () => {
            console.log('Overlay window fully loaded');
            console.log('All elements initialized');
        });
        
        function updateSelection() {
            const left = Math.min(startX, endX);
            const top = Math.min(startY, endY);
            const width = Math.abs(endX - startX);
            const height = Math.abs(endY - startY);
            
            selectionBox.style.left = left + 'px';
            selectionBox.style.top = top + 'px';
            selectionBox.style.width = width + 'px';
            selectionBox.style.height = height + 'px';
            
            // Update info panel
            infoPanel.textContent = `${width} × ${height} px`;
            infoPanel.style.left = Math.min(endX + 10, window.innerWidth - infoPanel.offsetWidth) + 'px';
            infoPanel.style.top = Math.max(endY - 30, 0) + 'px';
            
            return { x: left, y: top, width, height };
        }
        
        function setupEventHandlers() {
            console.log('Setting up event handlers...');
            
            document.addEventListener('mousedown', (e) => {
                // Don't start selection if clicking on buttons or controls
                if (e.target.closest('.capture-controls') || 
                    e.target.closest('button') || 
                    e.target.tagName === 'BUTTON') {
                    console.log('Mouse down on control element, ignoring');
                    return;
                }
                
                console.log('Mouse down:', e.clientX, e.clientY);
                isSelecting = true;
                startX = e.clientX;
                startY = e.clientY;
                endX = e.clientX;
                endY = e.clientY;
                
                selectionBox.style.display = 'block';
                infoPanel.style.display = 'block';
                captureControls.style.display = 'none';
                
                updateSelection();
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', (e) => {
                if (isSelecting) {
                    console.log('Mouse move:', e.clientX, e.clientY);
                    endX = e.clientX;
                    endY = e.clientY;
                    updateSelection();
                }
            });
            
            document.addEventListener('mouseup', (e) => {
                // Don't handle mouseup if it's on a control element
                if (e.target.closest('.capture-controls') || 
                    e.target.closest('button') || 
                    e.target.tagName === 'BUTTON') {
                    console.log('Mouse up on control element, ignoring');
                    return;
                }
                
                console.log('Mouse up:', e.clientX, e.clientY);
                if (isSelecting) {
                    isSelecting = false;
                    const selection = updateSelection();
                    console.log('Final selection:', selection);
                    
                    if (selection.width > 10 && selection.height > 10) {
                        captureControls.style.display = 'flex';
                        console.log('Showing capture controls');
                    } else {
                        // Reset selection if too small
                        selectionBox.style.display = 'none';
                        infoPanel.style.display = 'none';
                        console.log('Selection too small, hiding controls');
                    }
                }
            });
            
            // Add touch support for tablets/touchscreens
            document.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    const touch = e.touches[0];
                    console.log('Touch start:', touch.clientX, touch.clientY);
                    isSelecting = true;
                    startX = touch.clientX;
                    startY = touch.clientY;
                    endX = touch.clientX;
                    endY = touch.clientY;
                    
                    selectionBox.style.display = 'block';
                    infoPanel.style.display = 'block';
                    captureControls.style.display = 'none';
                    
                    updateSelection();
                    e.preventDefault();
                }
            });
            
            document.addEventListener('touchmove', (e) => {
                if (isSelecting && e.touches.length === 1) {
                    const touch = e.touches[0];
                    console.log('Touch move:', touch.clientX, touch.clientY);
                    endX = touch.clientX;
                    endY = touch.clientY;
                    updateSelection();
                    e.preventDefault();
                }
            });
            
            document.addEventListener('touchend', (e) => {
                console.log('Touch end');
                if (isSelecting) {
                    isSelecting = false;
                    const selection = updateSelection();
                    console.log('Final touch selection:', selection);
                    
                    if (selection.width > 10 && selection.height > 10) {
                        captureControls.style.display = 'flex';
                        console.log('Showing capture controls');
                    } else {
                        selectionBox.style.display = 'none';
                        infoPanel.style.display = 'none';
                        console.log('Selection too small, hiding controls');
                    }
                }
            });
        }
        
        // Initialize event handlers
        setupEventHandlers();
        
        captureBtn.addEventListener('click', async (e) => {
            console.log('=== CAPTURE BUTTON CLICKED ===');
            e.stopPropagation();
            e.preventDefault();
            
            const selection = updateSelection();
            console.log('Capture button clicked, selection:', selection);
            
            if (selection.width > 10 && selection.height > 10) {
                // Show visual feedback
                captureBtn.textContent = 'キャプチャ中...';
                captureBtn.disabled = true;
                
                try {
                    console.log('Starting capture with region:', selection);
                    
                    // Hide the overlay window before capturing
                    console.log('Hiding overlay for capture...');
                    await window.__TAURI__.core.invoke('hide_overlay_window');
                    
                    // Wait a moment for the window to fully hide
                    await new Promise(resolve => setTimeout(resolve, 200));
                    
                    // Perform the capture
                    const result = await window.__TAURI__.core.invoke('capture_region', {
                        region: {
                            x: Math.floor(selection.x),
                            y: Math.floor(selection.y),
                            width: Math.floor(selection.width),
                            height: Math.floor(selection.height)
                        }
                    });
                    
                    console.log('Capture successful, result:', result);
                    
                    // Close the overlay window after successful capture
                    console.log('Closing overlay window...');
                    await window.__TAURI__.core.invoke('close_overlay_window');
                    console.log('Overlay window closed');
                    
                } catch (error) {
                    console.error('Failed to capture region:', error);
                    
                    // Show the overlay again if there was an error
                    try {
                        await window.__TAURI__.core.invoke('show_overlay_window');
                    } catch (showError) {
                        console.error('Failed to show overlay after error:', showError);
                    }
                    
                    captureBtn.textContent = 'エラー';
                    captureBtn.style.background = '#EF4444';
                    alert('キャプチャに失敗しました: ' + error);
                    
                    // Reset button after error
                    setTimeout(() => {
                        captureBtn.textContent = 'キャプチャ';
                        captureBtn.style.background = '#007AFF';
                        captureBtn.disabled = false;
                    }, 2000);
                }
            } else {
                console.log('Selection too small, not capturing');
                alert('選択範囲が小さすぎます。もう少し大きな範囲を選択してください。');
            }
        });
        
        cancelBtn.addEventListener('click', async (e) => {
            console.log('=== CANCEL BUTTON CLICKED ===');
            e.stopPropagation();
            e.preventDefault();
            
            try {
                await window.__TAURI__.core.invoke('close_overlay_window');
            } catch (error) {
                console.error('Failed to close overlay:', error);
            }
        });
        
        // ESC key to cancel
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                try {
                    window.__TAURI__.core.invoke('close_overlay_window');
                } catch (error) {
                    console.error('Failed to close overlay:', error);
                }
            }
        });
    </script>
</body>
</html>